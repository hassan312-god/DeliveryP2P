<?php
/**
 * Script de test pour l'authentification LivraisonP2P
 * Teste l'int√©gration avec Supabase et les emails de confirmation
 */

require_once 'php/config.php';
require_once 'php/supabase-api.php';
require_once 'php/email-service.php';

class AuthTest {
    private $config;
    private $supabase;
    private $emailService;
    
    public function __construct() {
        $this->config = new Config();
        $this->supabase = new SupabaseAPI();
        $this->emailService = new EmailService();
    }
    
    /**
     * Test de connexion √† Supabase
     */
    public function testSupabaseConnection() {
        echo "=== Test de connexion Supabase ===\n";
        
        try {
            $result = $this->supabase->testConnection();
            
            if ($result['success']) {
                echo "‚úÖ Connexion Supabase r√©ussie\n";
                return true;
            } else {
                echo "‚ùå √âchec de connexion Supabase: " . $result['error'] . "\n";
                return false;
            }
        } catch (Exception $e) {
            echo "‚ùå Erreur de connexion: " . $e->getMessage() . "\n";
            return false;
        }
    }
    
    /**
     * Test d'inscription d'utilisateur
     */
    public function testUserRegistration() {
        echo "\n=== Test d'inscription utilisateur ===\n";
        
        $testEmail = 'test-' . time() . '@example.com';
        $testPassword = 'TestPassword123!';
        
        $userData = [
            'email' => $testEmail,
            'password' => $testPassword,
            'nom' => 'Test',
            'prenom' => 'Utilisateur',
            'telephone' => '+33123456789',
            'role' => 'client'
        ];
        
        try {
            // Test d'inscription via Supabase Auth
            $authResult = $this->supabase->signUp($userData['email'], $userData['password'], [
                'nom' => $userData['nom'],
                'prenom' => $userData['prenom'],
                'telephone' => $userData['telephone'],
                'role' => $userData['role']
            ]);
            
            if ($authResult['success']) {
                echo "‚úÖ Inscription Supabase r√©ussie\n";
                $userId = $authResult['data']['user']['id'];
                
                // Test de cr√©ation du profil
                $profileResult = $this->supabase->insert('profiles', [
                    'id' => $userId,
                    'email' => $userData['email'],
                    'nom' => $userData['nom'],
                    'prenom' => $userData['prenom'],
                    'telephone' => $userData['telephone'],
                    'role' => $userData['role'],
                    'date_inscription' => date('Y-m-d H:i:s'),
                    'statut' => 'en_attente_confirmation',
                    'email_confirme' => false
                ]);
                
                if ($profileResult['success']) {
                    echo "‚úÖ Cr√©ation du profil r√©ussie\n";
                    
                    // Test d'envoi d'email de confirmation
                    $token = bin2hex(random_bytes(32));
                    $emailResult = $this->emailService->sendConfirmationEmail($userId, $userData['email'], $token);
                    
                    if ($emailResult['success']) {
                        echo "‚úÖ Email de confirmation envoy√©\n";
                    } else {
                        echo "‚ö†Ô∏è √âchec envoi email: " . $emailResult['error'] . "\n";
                    }
                    
                    return $userId;
                } else {
                    echo "‚ùå √âchec cr√©ation profil: " . $profileResult['error'] . "\n";
                    return false;
                }
            } else {
                echo "‚ùå √âchec inscription: " . $authResult['error'] . "\n";
                return false;
            }
        } catch (Exception $e) {
            echo "‚ùå Erreur inscription: " . $e->getMessage() . "\n";
            return false;
        }
    }
    
    /**
     * Test de connexion utilisateur
     */
    public function testUserLogin($email, $password) {
        echo "\n=== Test de connexion utilisateur ===\n";
        
        try {
            $result = $this->supabase->signIn($email, $password);
            
            if ($result['success']) {
                echo "‚úÖ Connexion r√©ussie\n";
                echo "   - User ID: " . $result['data']['user']['id'] . "\n";
                echo "   - Email: " . $result['data']['user']['email'] . "\n";
                echo "   - Email confirm√©: " . ($result['data']['user']['email_confirmed_at'] ? 'Oui' : 'Non') . "\n";
                return $result['data']['user'];
            } else {
                echo "‚ùå √âchec connexion: " . $result['error'] . "\n";
                return false;
            }
        } catch (Exception $e) {
            echo "‚ùå Erreur connexion: " . $e->getMessage() . "\n";
            return false;
        }
    }
    
    /**
     * Test de r√©cup√©ration de profil
     */
    public function testGetUserProfile($userId) {
        echo "\n=== Test de r√©cup√©ration de profil ===\n";
        
        try {
            $result = $this->supabase->select('profiles', '*', ['id' => $userId]);
            
            if ($result['success'] && !empty($result['data'])) {
                $profile = $result['data'][0];
                echo "‚úÖ Profil r√©cup√©r√©\n";
                echo "   - Nom: " . $profile['nom'] . " " . $profile['prenom'] . "\n";
                echo "   - Email: " . $profile['email'] . "\n";
                echo "   - R√¥le: " . $profile['role'] . "\n";
                echo "   - Statut: " . $profile['statut'] . "\n";
                echo "   - Email confirm√©: " . ($profile['email_confirme'] ? 'Oui' : 'Non') . "\n";
                return $profile;
            } else {
                echo "‚ùå √âchec r√©cup√©ration profil: " . ($result['error'] ?? 'Profil non trouv√©') . "\n";
                return false;
            }
        } catch (Exception $e) {
            echo "‚ùå Erreur r√©cup√©ration profil: " . $e->getMessage() . "\n";
            return false;
        }
    }
    
    /**
     * Test de mise √† jour de profil
     */
    public function testUpdateUserProfile($userId) {
        echo "\n=== Test de mise √† jour de profil ===\n";
        
        $updateData = [
            'telephone' => '+33987654321',
            'ville' => 'Paris',
            'code_postal' => '75001',
            'updated_at' => date('Y-m-d H:i:s')
        ];
        
        try {
            $result = $this->supabase->update('profiles', $updateData, ['id' => $userId]);
            
            if ($result['success']) {
                echo "‚úÖ Mise √† jour du profil r√©ussie\n";
                return true;
            } else {
                echo "‚ùå √âchec mise √† jour: " . $result['error'] . "\n";
                return false;
            }
        } catch (Exception $e) {
            echo "‚ùå Erreur mise √† jour: " . $e->getMessage() . "\n";
            return false;
        }
    }
    
    /**
     * Test d'envoi d'email de r√©initialisation
     */
    public function testPasswordResetEmail($email) {
        echo "\n=== Test d'email de r√©initialisation ===\n";
        
        $token = bin2hex(random_bytes(32));
        
        try {
            $result = $this->emailService->sendPasswordResetEmail($email, $token);
            
            if ($result['success']) {
                echo "‚úÖ Email de r√©initialisation envoy√©\n";
                return true;
            } else {
                echo "‚ùå √âchec envoi email: " . $result['error'] . "\n";
                return false;
            }
        } catch (Exception $e) {
            echo "‚ùå Erreur envoi email: " . $e->getMessage() . "\n";
            return false;
        }
    }
    
    /**
     * Test de la file d'attente des emails
     */
    public function testEmailQueue() {
        echo "\n=== Test de la file d'attente des emails ===\n";
        
        try {
            // Test des statistiques
            $statsResult = $this->emailService->getEmailStats();
            
            if ($statsResult['success']) {
                $stats = $statsResult['stats'];
                echo "üìä Statistiques des emails:\n";
                echo "   - Total: " . $stats['total_emails'] . "\n";
                echo "   - En attente: " . $stats['pending_emails'] . "\n";
                echo "   - Envoy√©s: " . $stats['sent_emails'] . "\n";
                echo "   - √âchecs: " . $stats['failed_emails'] . "\n";
                echo "   - Taux de succ√®s: " . $stats['success_rate'] . "%\n";
            }
            
            // Test de traitement de la file
            $queueResult = $this->emailService->processEmailQueue();
            
            if ($queueResult['success']) {
                echo "‚úÖ Traitement de la file d'attente:\n";
                echo "   - Trait√©s: " . $queueResult['processed'] . "\n";
                echo "   - Succ√®s: " . $queueResult['success_count'] . "\n";
                echo "   - √âchecs: " . $queueResult['failed_count'] . "\n";
            }
            
            return true;
        } catch (Exception $e) {
            echo "‚ùå Erreur file d'attente: " . $e->getMessage() . "\n";
            return false;
        }
    }
    
    /**
     * Test de d√©connexion
     */
    public function testUserLogout() {
        echo "\n=== Test de d√©connexion ===\n";
        
        try {
            $result = $this->supabase->signOut();
            
            if ($result['success']) {
                echo "‚úÖ D√©connexion r√©ussie\n";
                return true;
            } else {
                echo "‚ùå √âchec d√©connexion: " . $result['error'] . "\n";
                return false;
            }
        } catch (Exception $e) {
            echo "‚ùå Erreur d√©connexion: " . $e->getMessage() . "\n";
            return false;
        }
    }
    
    /**
     * Test complet de l'authentification
     */
    public function runFullTest() {
        echo "üöÄ D√©marrage des tests d'authentification LivraisonP2P\n";
        echo "================================================\n";
        
        // Test de connexion
        if (!$this->testSupabaseConnection()) {
            echo "\n‚ùå Test de connexion √©chou√©. Arr√™t des tests.\n";
            return false;
        }
        
        // Test d'inscription
        $userId = $this->testUserRegistration();
        if (!$userId) {
            echo "\n‚ùå Test d'inscription √©chou√©. Arr√™t des tests.\n";
            return false;
        }
        
        // Test de r√©cup√©ration de profil
        $profile = $this->testGetUserProfile($userId);
        if (!$profile) {
            echo "\n‚ùå Test de r√©cup√©ration de profil √©chou√©.\n";
        }
        
        // Test de mise √† jour de profil
        $this->testUpdateUserProfile($userId);
        
        // Test d'email de r√©initialisation
        $this->testPasswordResetEmail($profile['email']);
        
        // Test de la file d'attente
        $this->testEmailQueue();
        
        // Test de connexion (peut √©chouer si l'email n'est pas confirm√©)
        $testPassword = 'TestPassword123!';
        $user = $this->testUserLogin($profile['email'], $testPassword);
        
        // Test de d√©connexion
        $this->testUserLogout();
        
        echo "\n‚úÖ Tests termin√©s!\n";
        echo "================================================\n";
        
        return true;
    }
}

// Ex√©cution des tests si le script est appel√© directement
if (basename(__FILE__) == basename($_SERVER['SCRIPT_NAME'])) {
    $test = new AuthTest();
    $test->runFullTest();
}
?> 